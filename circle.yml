machine:
  services:
    - docker
      
checkout:
  post:
    - git fetch --tags
    - git submodule sync
    - git submodule update --init
    - mkdir -p root/
    
dependencies:
  override:
    - cd nanomsg; sh autogen.sh && ./configure --prefix=$(readlink -f ./package) && make && make check && sudo make install && cp -r ./package/* ../root/.
    - cd root; curl -k -L https://github.com/just-containers/s6-overlay/releases/download/v1.13.0.0/s6-overlay-amd64.tar.gz | tar xz
    - docker info
    - |
        ID=$(sudo docker build -t quay.io/redsift/baseos .)
        VERSION=$(git describe --exact-match --tags || git rev-parse --short HEAD)
        echo "Tagging as version $VERSION"
        docker tag $ID quay.io/redsift/baseos:$VERSION
    
test:
  override:
    - docker run -d quay.io/redsift/baseos; sleep 10    
    
deployment:
  prod:
    branch: master
    commands:
      - docker login -e $QUAY_EMAIL -u $QUAY_USER -p $QUAY_PASS quay.io
      - |
        export VERSION=$(git describe || git rev-parse --short HEAD)
        docker push quay.io/redsift/baseos
    